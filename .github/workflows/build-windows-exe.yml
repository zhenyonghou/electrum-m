name: Build Windows EXE

# è§¦å‘æ¡ä»¶ï¼šæ¨é€åˆ°main/masteråˆ†æ”¯ï¼Œæˆ–æ‰‹åŠ¨è§¦å‘
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-windows-exe:
    runs-on: ubuntu-latest
    
    steps:
    # 1. æ£€å‡ºä»£ç ï¼ˆåŒ…å«å­æ¨¡å—ï¼‰
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: 'recursive'
        fetch-depth: 0  # è·å–å®Œæ•´çš„gitå†å²
    
    # 2. è®¾ç½®Dockerç¯å¢ƒ
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    # 3. ç¼“å­˜Dockeré•œåƒå±‚ï¼ˆå¯é€‰ï¼ŒåŠ é€Ÿæ„å»ºï¼‰
    - name: Cache Docker layers
      uses: actions/cache@v3
      with:
        path: /tmp/.buildx-cache
        key: ${{ runner.os }}-buildx-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-buildx-
    
    # 4. æ„å»ºWindowsäºŒè¿›åˆ¶æ–‡ä»¶
    - name: Build Windows binaries
      run: |
        cd contrib/build-wine
        
        # æ£€æŸ¥Dockeræ˜¯å¦å¯ç”¨
        docker --version
        docker info
        
        # ç¡®ä¿æ‰€æœ‰è„šæœ¬éƒ½æœ‰æ‰§è¡Œæƒé™
        echo "Setting execute permissions for scripts..."
        chmod +x build-ci.sh build.sh make_win.sh build-github-actions.sh build-simple.sh build-final.sh fix-permissions.sh debug-permissions.sh build-ultimate.sh
        
        # é€’å½’è®¾ç½®æ•´ä¸ªé¡¹ç›®çš„è„šæœ¬æƒé™ï¼ˆéå¸¸é‡è¦ï¼ï¼‰
        echo "Setting permissions for ALL shell scripts in the project..."
        find ../../ -name "*.sh" -type f -exec chmod +x {} \; 2>/dev/null || true
        
        # ç‰¹åˆ«ç¡®ä¿å…³é”®æ„å»ºè„šæœ¬æœ‰æ‰§è¡Œæƒé™
        echo "Ensuring critical build scripts have execute permissions..."
        chmod +x ../../contrib/make_libsecp256k1.sh 2>/dev/null || true
        chmod +x ../../contrib/make_libusb.sh 2>/dev/null || true
        chmod +x ../../contrib/make_zbar.sh 2>/dev/null || true
        chmod +x ../../contrib/build_tools_util.sh 2>/dev/null || true
        
        # éªŒè¯å…³é”®è„šæœ¬æƒé™
        echo "Verifying critical script permissions:"
        ls -la *.sh
        ls -la ../../contrib/make_libsecp256k1.sh 2>/dev/null || echo "make_libsecp256k1.sh not found"
        ls -la ../../contrib/make_libusb.sh 2>/dev/null || echo "make_libusb.sh not found"
        ls -la ../../contrib/build_tools_util.sh 2>/dev/null || echo "build_tools_util.sh not found"
        
        # éªŒè¯å…³é”®è„šæœ¬ç¡®å®å¯è¯»
        echo "Testing if make_win.sh is readable:"
        head -5 make_win.sh || echo "Cannot read make_win.sh"
        
        # æ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿç±»å‹ï¼ˆæŸäº›æ–‡ä»¶ç³»ç»Ÿä¸æ”¯æŒæ‰§è¡Œæƒé™ï¼‰
        df -T . || echo "Cannot check filesystem type"
        
        # ä½¿ç”¨CIä¸“ç”¨çš„æ„å»ºè„šæœ¬ï¼ˆæ— äº¤äº’å¼æ ‡å¿—ï¼‰
        echo "Using CI-friendly build script..."
        
        # è®¾ç½®ç¯å¢ƒå˜é‡
        export CI=true
        
        # è®¾ç½®å¯é‡ç°æ„å»ºå¹¶è¿è¡Œ
        echo "Starting build process with ULTIMATE zero-permission solution..."
        echo "ğŸš€ Script priority order:"
        echo "  1. build-ultimate.sh - ğŸ¯ ULTIMATE: Zero permission dependencies"
        echo "  2. build-final.sh - Handles UID mapping and all permissions"
        echo "  3. build-simple.sh - Simple Docker execution"
        echo "  4. build-github-actions.sh - GitHub Actions optimized"
        echo "  5. build-ci.sh - CI environment script"
        echo "  6. build.sh (modified) - Original script with TTY fixes"
        echo "  7. Manual Docker - Last resort"
        echo ""
        
        # é¦–å…ˆå°è¯•ç»ˆæè„šæœ¬ï¼ˆå®Œå…¨ç»•è¿‡æƒé™é—®é¢˜ï¼‰
        echo "=== ğŸ¯ Trying Method 1: ULTIMATE zero-permission script ==="
        if ./build-ultimate.sh; then
          echo "===== ğŸ‰ ULTIMATE script succeeded! ====="
        elif ./build-final.sh; then
          echo "===== Final script succeeded ====="
        elif ./build-simple.sh; then
          echo "===== Simple script succeeded ====="
        elif ./build-github-actions.sh; then
          echo "===== GitHub Actions script succeeded ====="
        elif ELECBUILD_COMMIT=HEAD ./build-ci.sh; then
          echo "===== CI script succeeded ====="
        else
          echo "=== All automated scripts failed, trying manual methods ==="
          
          # æ–¹æ³•5ï¼šä¿®æ”¹åŸå§‹è„šæœ¬
          echo "=== Trying Method 5: Modified original script ==="
          sed -i 's/docker run -it/docker run/g' build.sh
          sed -i 's|./make_win.sh|bash make_win.sh|g' build.sh
          
          if ELECBUILD_COMMIT=HEAD ./build.sh; then
            echo "===== Modified original script succeeded ====="
          else
            # æ–¹æ³•6ï¼šæ‰‹åŠ¨Dockerå‘½ä»¤
            echo "=== Trying Method 6: Manual Docker commands ==="
            echo "Building Docker image manually..."
            docker build -t electrum-wine-builder-img .
            echo "Running Docker container manually..."
            docker run --rm \
              -v "$(pwd)/../..":/opt/wine64/drive_c/electrum \
              --workdir /opt/wine64/drive_c/electrum/contrib/build-wine \
              electrum-wine-builder-img \
              bash -c "echo 'Manual Docker run - applying fixes and executing make_win.sh'; bash fix-permissions.sh && bash make_win.sh"
              
            # æ£€æŸ¥æœ€ç»ˆç»“æœ
            if [ ! -f "dist/*.exe" ] && [ ! -f "../../contrib/build-wine/dist/*.exe" ]; then
              echo "===== ALL BUILD METHODS FAILED ====="
              echo "Please check the debug information below for details."
            fi
          fi
        fi
    
    # 5. åˆ—å‡ºç”Ÿæˆçš„æ–‡ä»¶ï¼ˆç”¨äºè°ƒè¯•ï¼‰
    - name: List generated files and debug info
      if: always()  # å³ä½¿æ„å»ºå¤±è´¥ä¹Ÿè¦è¿è¡Œ
      run: |
        echo "===== BUILD RESULT ANALYSIS ====="
        echo "Contents of contrib/build-wine/dist/:"
        ls -la contrib/build-wine/dist/ 2>/dev/null || echo "dist directory not found"
        
        echo "===== CHECKING FOR ANY OUTPUT FILES ====="
        find contrib/build-wine/ -name "*.exe" -o -name "*.zip" -o -name "*.msi" | head -20
        
        echo "===== DOCKER DEBUG INFO ====="
        echo "Docker containers (including stopped):"
        docker ps -a
        echo "Docker images:"
        docker images
        
        echo "===== LOG FILES ====="
        find contrib/build-wine/ -name "*.log" -exec echo "=== {} ===" \; -exec cat {} \; 2>/dev/null || echo "No log files found"
        
        echo "===== FILE PERMISSIONS CHECK ====="
        ls -la contrib/build-wine/*.sh
        
        echo "===== DISK SPACE ====="
        df -h
        
        echo "===== AVAILABLE MEMORY ====="
        free -h || echo "free command not available"
    
    # 6. ä¸Šä¼ æ„å»ºå¥½çš„exeæ–‡ä»¶
    - name: Upload Windows binaries
      uses: actions/upload-artifact@v4
      with:
        name: electrum-windows-exe-${{ github.sha }}
        path: |
          contrib/build-wine/dist/*.exe
          contrib/build-wine/dist/*.zip
        retention-days: 30
        if-no-files-found: error
    
    # 7. åˆ›å»ºReleaseï¼ˆå¯é€‰ï¼Œä»…åœ¨æ¨é€tagæ—¶ï¼‰
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          contrib/build-wine/dist/*.exe
          contrib/build-wine/dist/*.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 